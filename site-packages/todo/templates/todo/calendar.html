{% extends "base.html" %}
{% load static %}


{% block content %}
 <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
  <h3 class="text-bold text-dark">Agenda</h3>
</div>
</div>
  </div>
  </section>
   

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-3">
           <div class="sticky-top mb-3">
              <div class="card">
                <div class="card-header">
                 <h4>Gestisci eventi</h4>
                </div>
                <div class="card-body">
	  

  

	 
	 
	   <form action="" method="post">
	   {% csrf_token %}
	   
	   
	<div class="form-group">

	<!-- Scelta colore evento -->
	<div class="input-group mb-3">
	 <select name="color" class="form-control select2bs4_color" style="width: 100%;">
                    <option value="#0275d8">Blue</option>
                    <option value="#999999">Gray</option>
                    <option value="#5cb85c">Green</option>
                    <option value="#f0ad4e">Yellow</option>
					<option value="#d9534f">Red</option>
					<!-- icons creation powered by www.iconsdb.com -->

		</select> 
		</div>
		

		<!-- Titolo evento -->
		<div class="input-group mb-3">
		  <input type="text" class="form-control pull-right" name="title" placeholder="Descrizione" required>
		   <!-- <input type="number" name="event_name" value="{#{nome_evento}}">-->
		</div>

		<div class="togglediv_specific_time">
		<div class="input-group mb-3">
		<div class="input-group-prepend">
        <span class="input-group-text"><i class="far fa-clock"></i></span>
         </div>
		<input type="text" name="startTime" placeholder="Ora inizio evento" class="form-control pull-right" id="startTime">
		</div>
		
		<div class="input-group mb-3">
		<div class="input-group-prepend">
        <span class="input-group-text"><i class="far fa-clock"></i></span>
         </div>
		<input type="text" name="endTime" placeholder="Ora fine evento" class="form-control pull-right" id="endTime">
		</div>
		</div>
		
		
	<div class="togglediv_allDay">
		<div class="input-group mb-3">
		<div class="input-group-prepend">
        <span class="input-group-text"><i class="far fa-calendar"></i></span>
         </div>
		  <input type="text" name="start" class="form-control pull-right" placeholder="Data inizio evento" id="start">
		</div>
		

		<div class="input-group mb-3">
		<div class="input-group-prepend">
        <span class="input-group-text"><i class="far fa-calendar"></i></span>
         </div>
		   <input type="text" name="end" class="form-control pull-right" placeholder="Data fine evento" id="end">
		</div>
	</div>
		
		<!-- begin togglediv_recurrence -->
		<div class="togglediv_recurrence">
		
		<div class="input-group mb-3">
		<div class="input-group-prepend">
        <span class="input-group-text"><i class="far fa-calendar"></i></span>
         </div>
		<input type="text" name="startRecur" onfocus="(this.type='date')" class="form-control pull-right" placeholder="Data inizio ricorrenza">
		</div>
		
		<div class="input-group mb-3">
		<div class="input-group-prepend">
        <span class="input-group-text"><i class="far fa-calendar"></i></span>
         </div>
		<input type="text" name="endRecur" onfocus="(this.type='date')" class="form-control pull-right" placeholder="Data fine ricorrenza">
		</div>
	</div>
	<!-- end togglediv_recurrence -->
	
	<div class="togglediv_cadenza">
		<div class="input-group mb-3">
		<select name="daysOfWeek" class="form-control select2bs4" style="width: 100%;">
		<option value="">Seleziona cadenza</option>
		<option value="[0]">Sunday</option>
		<option value="[1]">Monday</option>
		<option value="[2]">Tuesday</option>
		<option value="[3]">Wednesday</option>
		<option value="[4]">Thursday</option>
		<option value="[5]">Friday</option>
		<option value="[6]">Saturday</option>
		</select>
		</div>
	</div>		
		
		
		
		<div class="togglediv_notify">
		
		<div class="input-group mb-3">
		<select name="notify_time" class="form-control select2bs4" style="width: 100%;">
		<option value="">Seleziona avviso</option>
		<option value="1H" id="sel_h1">1 ora prima</option>
		<option value="1D" id="sel_d1">1 giorno prima</option>
		<option value="7D" id="sel_d2">1 settimana prima</option>
		</select>
		</div>
		</div>
		
		
		<!-- Pulsantiera -->
			<table class="table table-bordered">

			<tbody>
			<tr>
			<td><label id="label_durata">Tutto il giorno</label><br></td>
			<td style="text-align:center;">
			<input type="checkbox" name="allDay" id="durata_evento" checked="true" data-toggle="toggle" data-on="On" data-off="On" data-onstyle="success" data-offstyle="success" data-size="normal">
			</td>
			</tr>
			<tr>
			<td><label id="label_isRecur">Ricorrente</label></td>
			<td style="text-align:center;">
			<input type="checkbox" name="isRecur" id="isRecur"  data-toggle="toggle" data-on="On" data-off="Off" data-onstyle="success" data-offstyle="secondary" data-size="normal">
			</td>
			</tr>
			<tr class="togglediv_recur_everyday">
			<td><label id="label_recur_everyday">Ogni giorno</label></td>
			<td style="text-align:center;">
			<input type="checkbox" name="recur_everyday" id="recur_everyday" checked="true" data-toggle="toggle" data-on="On" data-off="Off" data-onstyle="success" data-offstyle="secondary" data-size="normal">
			</td>
			</tr>
			<tr class="togglediv_avvisami">
			<td><label id="label_notify">Avvisami</label></td>
			<td style="text-align:center;">
			<input type="checkbox" id="notify" data-toggle="toggle" data-on="On" data-off="Off" data-onstyle="success" data-offstyle="secondary" data-size="normal">
			</td>
			</tr>
			</tbody>
			</table>
			

		<!-- Pulsante submit -->
		<button class="btn btn-primary" type="submit" name="submit" value="Submit">Add</button>
	
		</div>
		 </form>
	  <!-- /.form group -->

		 <!-- the events -->
		 <div id="external-events">
		  </div>
		</div>
		<!-- /.card-body -->
	  </div>
	  <!-- /.card -->
	</div>
  </div>


  <!-- /.col -->
  <div class="col-md-9">
	<div class="card card-primary">
	  <div class="card-body p-0">
		<!-- THE CALENDAR -->
		<div id="calendar"></div>
	  </div>
	  <!-- /.card-body -->
	</div>
	<!-- /.card -->
  </div>
  <!-- /.col -->
</div>
<!-- /.row -->
</div><!-- /.container-fluid -->
</section>
<!-- /.content -->
</div>
<!-- /.content-wrapper -->
<!-- FINE HTML -->



<!-- funzione fullCalendar -->
<script>
$(function () {

    /* initialize the external events
     -----------------------------------------------------------------*/
    function ini_events(ele) {
      ele.each(function () {

        // create an Event Object (https://fullcalendar.io/docs/event-object)
        // it doesn't need to have a start or end
        var eventObject = {
          title: $.trim($(this).text()) // use the element's text as the event title
        }

        // store the Event Object in the DOM element so we can get to it later
        $(this).data('eventObject', eventObject)

        // make the event draggable using jQuery UI
        $(this).draggable({
          zIndex        : 1070,
          revert        : true, // will cause the event to go back to its
          revertDuration: 0  //  original position after the drag
        })

      })
    }

    ini_events($('#external-events div.external-event'))

    /* initialize the calendar
     -----------------------------------------------------------------*/
    //Date for the calendar events (dummy data)
    var date = new Date()
    var d    = date.getDate(),
        m    = date.getMonth(),
        y    = date.getFullYear()

    var Calendar = FullCalendar.Calendar;
    var Draggable = FullCalendar.Draggable;

    var containerEl = document.getElementById('external-events');
    var checkbox = document.getElementById('drop-remove');
    var calendarEl = document.getElementById('calendar');

    // initialize the external events
    // -----------------------------------------------------------------

    new Draggable(containerEl, {
      itemSelector: '.external-event',
      eventData: function(eventEl) {
        return {
          title: eventEl.innerText,
          backgroundColor: window.getComputedStyle( eventEl ,null).getPropertyValue('background-color'),
          borderColor: window.getComputedStyle( eventEl ,null).getPropertyValue('background-color'),
          textColor: window.getComputedStyle( eventEl ,null).getPropertyValue('color'),
        };
      }
    });

    var calendar = new Calendar(calendarEl, {
	slotDuration: '01:00', 	// 1 hour
      headerToolbar: {
        left  : 'prev,next today',
        center: 'title',
        right : 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      themeSystem: 'bootstrap',
	  //weekNumbers: true,
      navLinks: true,
	  
    //locale: 'it',
	
	eventSources: 
	[
    // your event source
    {
      url: '{% url 'todo:events_list' %}', // use the `url` property
      //color: 'yellow',    // an option!
      //textColor: 'black'  // an option!
    }

    // any other sources...

	],
	
	
	editable  : false,
	});
	
	
    calendar.render();
	
	calendar.on('eventClick', function (info) {
	info.el.style.borderColor = 'red';

	//funzione rimuovi evento
	var deleteMsg = confirm("Vuoi rimuovere questo evento?");
	if (deleteMsg) {
	  // Get event ID
	  var vEventId = info.event.id;
	  // Remove event from fullcalendar
	  info.event.remove();
	  // Call ajax to remove event from database table
	  var data1 = {eventId: vEventId};
	  $.ajax({
		url: '{% url 'todo:delete_event' %}',
		dataType: 'text',
		method: "POST",
		data : {
		csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
		data: JSON.stringify(data1),
		},
		success: function(data, status, xhr){
			//console.log(data);
			//console.log(data1);
			//console.log( JSON.stringify(data1));
		},
		error: function(xhr, status, error){
			//console.log(error);
			//console.log(data1);
			//console.log(xhr.responseText);
		}
	  });
	}
  
	
	});


  })
</script>


<!-- funzioni pulsanti -->
<script>

//*************************VARIABILI GLOBALI*************************
	var stato_checkbox_durata_evento = {};
	var stato_checkbox_isRecur = {};
	var stato_checkbox_notify = {};
	
//*************************AL CARICAMENTO DELLA PAGINA*************************
	$(function () {
	
//*************************CALCOLO DATA DI OGGI CON MOMENT.JS PER DATERANGEPICKER*************************
	var today = moment().add(2, 'hours');;
	var tomorrow = moment().add(1, 'days');;
	var tomorrow_formatted = moment(tomorrow).format("YYYY-MM-DD")

//*************************MOSTRA IL DIV DI DEFAULT E NASCONDI IL RESTO*************************
	$(".togglediv_allDay").show();
	$(".togglediv_recurrence").hide();
	$(".togglediv_specific_time").hide();
	$(".togglediv_notify").hide();
	$(".togglediv_recur_everyday").hide();
	$(".togglediv_cadenza").hide();
	
//*************************INIZIALIZZA DATERANGEPICKER PER CAMPI START e END*************************
	$('#start, #end').daterangepicker({
      timePicker: false,
	  singleDatePicker: true,
      locale: {
        format: 'DD/MM/YYYY',
		applyLabel: 'Applica',
        cancelLabel: 'Annulla',
      }
    })

//*************************INIZIALIZZA DATETIMEPICKER (OROLOGIO) PER CAMPI STARTTIME e ENDTIME*************************
	$('#startTime, #endTime').datetimepicker({
		format: 'HH:mm',
		stepping: 15,
    });
	
//*************************PULSANTE TUTTO IL GIORNO/IMPOSTA ORARIO E RELAZIONE CON PULSANTE RICORRENTE*************************	
	$('#durata_evento, #isRecur').change(function() {
	stato_checkbox_durata_evento = $('#durata_evento').prop('checked')
	stato_checkbox_isRecur = $('#isRecur').prop('checked')

	
	if(stato_checkbox_durata_evento == false && stato_checkbox_isRecur == true){
	$(".togglediv_specific_time").show();
	}
	
	if(stato_checkbox_durata_evento == true && stato_checkbox_isRecur == true){
	$(".togglediv_specific_time").hide();
	$(".togglediv_allDay").hide();
	}
	
	
	if(stato_checkbox_durata_evento == true && stato_checkbox_isRecur == false){
	$(".togglediv_allDay").show();
	$('#label_durata').text('Tutto il giorno');	
	}
	
	if(stato_checkbox_durata_evento == false && stato_checkbox_isRecur == false){
	$(".togglediv_specific_time").hide();
	$('#label_durata').text('Imposta orario');
	}
});	

//*************************PULSANTE AVVISAMI E RELAZIONE CON PULSANTE TUTTO IL GIORNO/IMPOSTA ORARIO*************************		
	$('#notify, #durata_evento').change(function() {
	stato_checkbox_notify = $('#notify').prop('checked')
	stato_checkbox_durata_evento = $('#durata_evento').prop('checked')
	stato_checkbox_isRecur = $('#isRecur').prop('checked')

	//Aggiungi attributo min ai campi startRecur e endRecur
	document.getElementsByName("startRecur")[0].setAttribute('min', tomorrow_formatted);
	document.getElementsByName("endRecur")[0].setAttribute('min', tomorrow_formatted);

	if(stato_checkbox_durata_evento == true && stato_checkbox_notify == true){
	$(".togglediv_notify").show();
	//Nascondi le selezioni orarie del campo Avvisami
	$('#sel_h1').wrap('<span>');
	
	$('#start, #end').daterangepicker({
	  minDate: tomorrow,
      timePicker: false,
	  singleDatePicker: true,
      timePickerIncrement: 15,
      locale: {
        format: 'DD/MM/YYYY HH:mm',
		applyLabel: 'Applica',
        cancelLabel: 'Annulla',
      }
    })
	
	}
	
	if(stato_checkbox_durata_evento == false && stato_checkbox_notify == true){
	$(".togglediv_notify").show();
	//Mostra le selezioni orarie del campo Avvisami
	$('#sel_h1').unwrap();
	
	$('#start, #end').daterangepicker({
	  minDate: today,
      timePicker: true,
	  timePicker24Hour: true,
	  singleDatePicker: true,
      timePickerIncrement: 15,
      locale: {
        format: 'DD/MM/YYYY HH:mm',
		applyLabel: 'Applica',
        cancelLabel: 'Annulla',
      }
    })
	
	}


	if(stato_checkbox_notify == false) {
	$(".togglediv_notify").hide();
	//Nascondi le selezioni orarie del campo Avvisami
	$('#sel_h1').wrap('<span>');
	
	$('#start, #end').daterangepicker({
      timePicker: true,
	  timePicker24Hour: true,
	  singleDatePicker: true,
      timePickerIncrement: 15,
      locale: {
        format: 'DD/MM/YYYY HH:mm',
		//firstDay: 1,
		applyLabel: 'Applica',
        cancelLabel: 'Annulla',
      }
    })
	
	//Togli attributo min da campi startRecur e endRecur	
	document.getElementsByName("startRecur")[0].removeAttribute('min');
	document.getElementsByName("endRecur")[0].removeAttribute('min');
	
	}

});
//*************************PULSANTE RICORRENTE E RELAZIONE CON PULSANTE AVVISAMI*************************
	$("#isRecur, notify").change(function() {
	stato_checkbox_isRecur = $('#isRecur').prop('checked')
	
	if(stato_checkbox_isRecur == true) {
	$(".togglediv_recurrence").show();
	$(".togglediv_allDay").hide();
	$(".togglediv_recur_everyday").show();
	} else {
	$(".togglediv_recurrence").hide();
	$(".togglediv_allDay").show();
	$(".togglediv_recur_everyday").hide();
	}
	
	})

	
//*************************PULSANTE OGNI GIORNO*************************		
	$("#recur_everyday").change(function() {
	var stato_checkbox_recur_everyday = $('#recur_everyday').prop('checked')
	if(stato_checkbox_recur_everyday == true) {
	$(".togglediv_cadenza").hide();
	} else {
	$(".togglediv_cadenza").show();
	}
	})
	
});
</script>


<!-- funzione seleziona colore evento -->
<script>
	//Add icon 
	function formatText (icon) {
    //return $('<span><i class="fas ' + $(icon.element).data('icon') + '"></i> ' + icon.text + '</span>');
	if (!icon.id) { return icon.text; }
	var $icon = $(
    '<span><img src="{% static 'plugins/fontawesome-free/icons/' %}' + icon.text.toLowerCase() +
    '.png"/> '  + icon.element.text + '</span>');
	return $icon;
	};

	//Initialize Select2 Elements
	$(function () {
     //Initialize Select2 Elements
    $('.select2bs4_color').select2({
	placeholder: 'Select event color',
	allowClear: true,
	theme: 'bootstrap4',
    templateResult: formatText,
    })
	
	$('.select2bs4').select2({
	//allowClear: true,
	theme: 'bootstrap4',
    })
	
	})
</script>
{% endblock %}
