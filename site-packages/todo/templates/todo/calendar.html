{% extends "base.html" %}
{% load static %}


{% block content %}
 <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
  <h2>Agenda</h2>
</div>
</div>
  </div>
  </section>
   

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-3">
           <div class="sticky-top mb-3">
              <div class="card">
                <div class="card-header">
                 <h4>Gestisci eventi<span class="badge badge-primary"></span></h4>
                </div>
                <div class="card-body">
	  
	   <form action="" method="post">
	   {% csrf_token %}
	   
	   
	<div class="form-group">
	
	<div class="input-group mb-3">
		<div class="form-group">
		<label id="label_form_type">Appunto</label><br>
		<input type="checkbox" name="note" id="note" data-toggle="toggle" data-on="On" data-off="Off" data-onstyle="success" data-offstyle="secondary" data-size="small">
		</div>
		</div>
	
	<!-- color choice -->
	<div class="input-group mb-3">
	 <select name="color" class="form-control select2bs4_color" style="width: 100%;">
                    <option value="#0275d8">Blue</option>
                    <option value="#999999">Gray</option>
                    <option value="#5cb85c">Green</option>
                    <option value="#f0ad4e">Yellow</option>
					<option value="#d9534f">Red</option>
					<!-- icons creation powered by www.iconsdb.com -->

		</select> 
		</div>
		


		
		<div class="input-group mb-3">
		  <input type="text" class="form-control pull-right" name="title" placeholder="Descrizione" required>
		</div>


		<div class="row">
		
		<div class="col-sm-4">
		<div class="form-group">
		<label id="label_durata">Tutto il giorno</label><br>
		<input type="checkbox" name="allDay" id="durata_evento" checked="true" data-toggle="toggle" data-on="On" data-off="On" data-onstyle="success" data-offstyle="success" data-size="small">
		</div>
		</div>

		<div class="col-sm-4">
		<div class="form-group">
		<label id="label_isRecur">Ricorrente</label><br>
		<input type="checkbox" name="isRecur" id="isRecur"  data-toggle="toggle" data-on="On" data-off="Off" data-onstyle="success" data-offstyle="secondary" data-size="small">
		</div>
		</div>

		
		<div class="togglediv_avvisami">
		<div class="col-sm-4">
		<div class="form-group">
		<label id="label_notify">Avvisami</label><br>
		<input type="checkbox" id="notify" data-toggle="toggle" data-on="On" data-off="Off" data-onstyle="success" data-offstyle="secondary" data-size="small">
		</div>
		</div>
		</div>

		</div>
		
		<div class="togglediv_specific_time">
		<div class="form-group">
		<input type="text" name="startTime" id="startTime" class="form-control pull-right" placeholder="Seleziona orario d&apos;inizio">
		<input type="text" name="endTime" id="endTime" class="form-control pull-right" placeholder="Selezione orario di fine">
		</div>
		</div>
		
		
		<div class="input-group mb-3">
		<div class="input-group-prepend">
        <span class="input-group-text"><i class="far fa-clock"></i></span>
         </div>
		  <input type="text" name="start" class="form-control pull-right"  placeholder="Start time" id="start">
		</div>

		<div class="input-group mb-3">
		<div class="input-group-prepend">
        <span class="input-group-text"><i class="far fa-clock"></i></span>
         </div>
		   <input type="text" name="end" class="form-control pull-right"  placeholder="End time" id="end">
		</div>
		
		
		<!-- begin togglediv_recurrence -->
		<div class="togglediv_recurrence">
		
		<div class="input-group mb-3">
		<div class="input-group-prepend">
        <span class="input-group-text"><i class="far fa-clock"></i></span>
         </div>
		<input type="text" name="startRecur" onfocus="(this.type='date')" class="form-control pull-right" placeholder="Data inizio ricorrenza">
		</div>
		
		<div class="input-group mb-3">
		<div class="input-group-prepend">
        <span class="input-group-text"><i class="far fa-clock"></i></span>
         </div>
		<input type="text" name="endRecur" onfocus="(this.type='date')" class="form-control pull-right" placeholder="Data fine ricorrenza">
		</div>

		<div class="input-group mb-3">
		<select name="daysOfWeek" class="form-control" style="width: 100%;">
		<option value="">Seleziona cadenza</option>
		<option value="[0]">Sunday</option>
		<option value="[1]">Monday</option>
		<option value="[2]">Tuesday</option>
		<option value="[3]">Wednesday</option>
		<option value="[4]">Thursday</option>
		<option value="[5]">Friday</option>
		<option value="[6]">Saturday</option>
		</select>
		</div>
			
		</div>
		<!-- end togglediv_recurrence -->
		
		<div class="togglediv_notify">
		
		<div class="input-group mb-3">
		<select name="notify_time" class="form-control" style="width: 100%;">
		<option value="">Seleziona avviso</option>
		<option value="0">1 ora prima</option>
		<option value="1">1 giorno prima</option>
		<option value="7">1 settimana prima</option>
		</select>
		</div>
		
		</div>
		
		<button class="btn btn-primary" type="submit" name="submit" id="submit" value="Submit">Add</button>
	
		</div>
		 </form>
	  <!-- /.form group -->

		 <!-- the events -->
		  <div id="external-events">
		  </div>
		</div>
		<!-- /.card-body -->
	  </div>
	  <!-- /.card -->
	</div>
  </div>


  <!-- /.col -->
  <div class="col-md-9">
	<div class="card card-primary">
	  <div class="card-body p-0">
		<!-- THE CALENDAR -->
		<div id="calendar"></div>
	  </div>
	  <!-- /.card-body -->
	</div>
	<!-- /.card -->
  </div>
  <!-- /.col -->
</div>
<!-- /.row -->
</div><!-- /.container-fluid -->
</section>
<!-- /.content -->
</div>
<!-- /.content-wrapper -->
<!-- FINE HTML -->
 
 
<!-- funzione fullCalendar -->
<script>
  $(function () {

    /* initialize the external events
     -----------------------------------------------------------------*/
    function ini_events(ele) {
      ele.each(function () {

        // create an Event Object (https://fullcalendar.io/docs/event-object)
        // it doesn't need to have a start or end
        var eventObject = {
          title: $.trim($(this).text()) // use the element's text as the event title
        }

        // store the Event Object in the DOM element so we can get to it later
        $(this).data('eventObject', eventObject)

        // make the event draggable using jQuery UI
        $(this).draggable({
          zIndex        : 1070,
          revert        : true, // will cause the event to go back to its
          revertDuration: 0  //  original position after the drag
        })

      })
    }

    ini_events($('#external-events div.external-event'))

    /* initialize the calendar
     -----------------------------------------------------------------*/
    //Date for the calendar events (dummy data)
    var date = new Date()
    var d    = date.getDate(),
        m    = date.getMonth(),
        y    = date.getFullYear()

    var Calendar = FullCalendar.Calendar;
    var Draggable = FullCalendar.Draggable;

    var containerEl = document.getElementById('external-events');
    var checkbox = document.getElementById('drop-remove');
    var calendarEl = document.getElementById('calendar');

    // initialize the external events
    // -----------------------------------------------------------------

    new Draggable(containerEl, {
      itemSelector: '.external-event',
      eventData: function(eventEl) {
        return {
          title: eventEl.innerText,
          backgroundColor: window.getComputedStyle( eventEl ,null).getPropertyValue('background-color'),
          borderColor: window.getComputedStyle( eventEl ,null).getPropertyValue('background-color'),
          textColor: window.getComputedStyle( eventEl ,null).getPropertyValue('color'),
        };
      }
    });

    var calendar = new Calendar(calendarEl, {
	slotDuration: '01:00', 	// 1 hour
      headerToolbar: {
        left  : 'prev,next today',
        center: 'title',
        right : 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      themeSystem: 'bootstrap',
	  //weekNumbers: true,
      navLinks: true,
	  
    //locale: 'it',
	
	eventSources: 
	[
    // your event source
    {
      url: '{% url 'todo:events_list' %}', // use the `url` property
      //color: 'yellow',    // an option!
      //textColor: 'black'  // an option!
    }

    // any other sources...

	],
	
	
	editable  : false,
	});
	
	
    calendar.render();
	
	calendar.on('eventClick', function (info) {
	info.el.style.borderColor = 'red';

	//funzione rimuovi evento
	var deleteMsg = confirm("Vuoi rimuovere questo evento?");
	if (deleteMsg) {
	  // Get event ID
	  var vEventId = info.event.id;
	  // Remove event from fullcalendar
	  info.event.remove();
	  // Call ajax to remove event from database table
	  var data1 = {eventId: vEventId};
	  $.ajax({
		url: '{% url 'todo:delete_event' %}',
		dataType: 'text',
		method: "POST",
		data : {
		csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
		data: JSON.stringify(data1),
		},
		success: function(data, status, xhr){
			//console.log(data);
			//console.log(data1);
			//console.log( JSON.stringify(data1));
		},
		error: function(xhr, status, error){
			//console.log(error);
			//console.log(data1);
			//console.log(xhr.responseText);
		}
	  });
	}
  
	
	});


  })
</script>

<!-- example Ajax function get id of checked checkbox and send it -->
<script>
/*
$('.form-check-input').click(function() {
    //alert($(this).attr('id'));  //-->this will alert id of checked checkbox.
	var data1 = $(this).attr('id');
       if(this.checked){
            $.ajax({
                type: "POST",
                url: '{% url 'todo:events_list' %}',
                data: {
				csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken').val(),
				data: $(this).attr('id'), //--> send id of checked checkbox on other page
				},
				success: function(data) {
                    alert('it worked');
                    alert(data1);
                    //$('#container').html(data); //--> send id of checked checkbox on <div id="container">
                },
                error: function() {
                    alert('it broke');
                }
 
            });

            }
      });
	  */
</script>

<!-- funzioni per ogni toggle e daterangepicker -->
<script>
	$(function () {
	
	//Get today date first
	var today = new Date();    var dd = today.getDate(); 
    var mm = today.getMonth()+1; //January is 0! 
    var yyyy = today.getFullYear(); 
    if(dd<10){ dd='0'+dd } 
    if(mm<10){ mm='0'+mm } 
    var today = dd+'/'+mm+'/'+yyyy; 

	//Set a globally scoped object(variable)
	var data_con_orario = {};
		
	//Set default value
	data_con_orario = 0;
	
	//Inizializza daterangepicker 
	init_daterangepicker();
	
	//Metti di default gli input date con type="date"
	$('#start').replaceWith('<input type="date" name="start" id="start" class="form-control pull-right">');
	$('#end').replaceWith('<input type="date" name="end" id="end" class="form-control pull-right">');
	
	//disable past dates into html input date fields
	var oggi = new Date().toISOString().split('T')[0];
	document.getElementsByName("start")[0].setAttribute('min', oggi);
	document.getElementsByName("end")[0].setAttribute('min', oggi);
	
	
	function init_daterangepicker() {
	//Set locale here
	//moment.locale('it');
	
    $('#start').daterangepicker({
	  minDate: today,
      timePicker: true,
	  timePicker24Hour: true,
	  singleDatePicker: true,
      timePickerIncrement: 30,
      locale: {
        format: 'DD/MM/YYYY HH:mm',
		//firstDay: 1,
		applyLabel: 'Applica',
        cancelLabel: 'Annulla',
      }
    })
	
	 $('#end').daterangepicker({
	  minDate: today,
      timePicker: true,
	  timePicker24Hour: true,
	  singleDatePicker: true,
      timePickerIncrement: 30,
      locale: {
        format: 'DD/MM/YYYY HH:mm',
		//firstDay: 1,
		applyLabel: 'Applica',
        cancelLabel: 'Annulla',
      }
    })
	}
	
	//Hide specific div by default
	$(".togglediv_recurrence").hide();
	$(".togglediv_specific_time").hide();
	$(".togglediv_notify").hide();


	$('#note').change(function() {
	var stato_checkbox_appunto = $('#note').prop('checked')
	if(stato_checkbox_appunto == true) {
	document.getElementsByName("start")[0].removeAttribute('min');
	document.getElementsByName("end")[0].removeAttribute('min');
	$(".togglediv_avvisami").hide();
	}else{
	document.getElementsByName("start")[0].setAttribute('min', oggi);
	document.getElementsByName("end")[0].setAttribute('min', oggi);
	$(".togglediv_avvisami").show();
	}
	})
	
	
	$('#durata_evento').change(function() {
	var stato_checkbox_durata_evento = $('#durata_evento').prop('checked')
	if(stato_checkbox_durata_evento == true) {
	$('#start').replaceWith('<input type="date" name="start" id="start" class="form-control pull-right">');
	$('#end').replaceWith('<input type="date" name="end" id="end" class="form-control pull-right">');
	$('#label_durata').text('Tutto il giorno');	
	//Change global variable before ajax call
	data_con_orario = 0;
	}
	else {
	$('#start').replaceWith('<input type="text" name="start" class="form-control pull-right"  placeholder="Start time" id="start">');
	$('#end').replaceWith('<input type="text" name="end" class="form-control pull-right"  placeholder="End time" id="end">');
	init_daterangepicker();
	$('#label_durata').text('Imposta orario');
	$(".togglediv_recurrence").hide();
	$("#isRecur").bootstrapToggle('off');
	//Change global variable before ajax call
	data_con_orario = 1;
	}
	})
	
	
	$("#isRecur").change(function() {
	var stato_checkbox_isRecur = $('#isRecur').prop('checked')
	if(stato_checkbox_isRecur == true) {
	$(".togglediv_recurrence").show();
	$('#start').replaceWith('<input type="date" name="start" id="start" class="form-control pull-right">');
	$('#end').replaceWith('<input type="date" name="end" id="end" class="form-control pull-right">');
	$('#label_durata').text('Tutto il giorno');
	} else {
	$(".togglediv_recurrence").hide();
	$('#start').replaceWith('<input type="text" name="start" class="form-control pull-right"  placeholder="Start time" id="start">');
	$('#end').replaceWith('<input type="text" name="end" class="form-control pull-right"  placeholder="End time" id="end">');
	init_daterangepicker();
	$('#label_durata').text('Imposta orario');
	
	}
	})
	
	//Prendi la data inserita dall'utente in input e controlla se equivale a quella di oggi
	$("#start").change(function() {
	var data_utente = $('#start').val();
	var data_utente_format = moment(data_utente).format('DD/MM/YYYY'); 
	
	//Se uguale o inferiore alla data di oggi nascondi toggle per avviso
	if((data_utente_format == today)||(data_utente_format < today)) {
	$(".togglediv_avvisami").hide();
	}else{
	$(".togglediv_avvisami").show();
	}
	});
	
	
	$("#notify").change(function() {
	var stato_checkbox_notify = $('#notify').prop('checked')
	if(stato_checkbox_notify == true) {
	$(".togglediv_notify").show();
	} else {
	$(".togglediv_notify").hide();
	}
	})
	
	
	//If user clicked submit button, call ajax to tell that date does not contain time 
	$('#submit').click(function() {
    $.ajax({
    url : '{% url 'todo:calendario' %}',
    type : 'POST',
    data : {
	csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
    dato : data_con_orario,
    },
    success : function(response) {
    /* this method executes on a successful response from the backend */
    var message = response.message
    }
    });

    })
	
	/*
	//If user clicked submit button, call ajax to tell that date does not contain time 
	$('#submit').click(function() {
    $.ajax({
    url : '{#% url 'todo:get_data_con_orario' %}',
	dataType: 'text',
	method: "POST",
	data : {
	csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
	dato: JSON.stringify(data_con_orario),
	},
	success: function(data, status, xhr){
		//console.log(data);
		//console.log(data1);
		//console.log( JSON.stringify(data1));
	},
	error: function(xhr, status, error){
		//console.log(error);
		//console.log(data1);
		//console.log(xhr.responseText);
	}
    });
	
    })
	*/
	
	
});
</script>


<!-- funzione seleziona colore evento -->
<script>
	//Add icon 
	function formatText (icon) {
    //return $('<span><i class="fas ' + $(icon.element).data('icon') + '"></i> ' + icon.text + '</span>');
	if (!icon.id) { return icon.text; }
	var $icon = $(
    '<span><img src="{% static 'plugins/fontawesome-free/icons/' %}' + icon.text.toLowerCase() +
    '.png"/> '  + icon.element.text + '</span>');
	return $icon;
	};

	//Initialize Select2 Elements
	$(function () {
     //Initialize Select2 Elements
    $('.select2bs4_color').select2({
	placeholder: 'Select event color',
	allowClear: true,
	theme: 'bootstrap4',
    templateResult: formatText,
    })
	
	$('.select2bs4_type').select2({
	placeholder: 'Select event type',
	allowClear: true,
	theme: 'bootstrap4',
    })
	
	})
</script>
{% endblock %}
