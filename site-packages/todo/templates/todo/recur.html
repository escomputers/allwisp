{% extends "base.html" %}
{% load static %}


{% block content %}
 <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
  <h3 class="text-bold text-dark">Emissione documenti ricorrenti</h3>
</div>
</div>
  </div>
  </section>
   

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-3">
           <div class="sticky-top mb-3">
              <div class="card">
                <div class="card-header">
                 <h4>Crea nuovo flusso</h4>
                </div>
                <div class="card-body">
			<form action="" method="post">
		{% csrf_token %}
	   
	   
	<div class="form-group">

	<!-- Scelta tipo documento -->
	<div class="input-group mb-3">
	<label for="doctype">Tipo documento</label>
	 <select id="doctype" multiple="multiple" class="select2bs4_doc" data-placeholder="Seleziona" style="width: 100%;">
		<option value="#0275d8">Fattura</option>
		<option value="#999999">Fattura proforma</option>
		<option value="#5cb85c">DDT</option>
		<option value="#f0ad4e">Note di credito</option>
		<option value="#d9534f">Note di debito</option>

		</select> 
		</div>
		
		<label for="title">Nome</label>
		<div class="input-group mb-3">
		  <input type="text" class="form-control pull-right" id="title" placeholder="Nome" required>
		</div>
		
		<label for="data_avvio_hidd">Data di avvio</label>
		<div class="input-group mb-3">
		 <input type="text" id="data_avvio_hidd" hidden>
		<div class="input-group-prepend">
        <span class="input-group-text"><i class="far fa-calendar"></i></span>
         </div>
		  <input type="text" id="data_avvio" onfocus="(this.type='date')" class="form-control pull-right" placeholder="Data avvio">
		</div>
		
		<label for="intervallo_date">Intervallo date</label>
		<div class="input-group mb-3">
		 <input type="text" id="intervallo_date" hidden>
		<div class="input-group-prepend">
        <span class="input-group-text"><i class="far fa-calendar"></i></span>
         </div>
		  <input type="text" id="start"  onfocus="(this.type='date')" class="form-control pull-right" placeholder="Data inizio">
		</div>
	
		<div class="input-group mb-3">
		<div class="input-group-prepend">
        <span class="input-group-text"><i class="far fa-calendar"></i></span>
         </div>
		   <input type="text" id="end"  onfocus="(this.type='date')" class="form-control pull-right" placeholder="Data fine">
		</div>
	
		<div class="togglediv_sel_cliente">
		<div class="input-group mb-3">
		<select id="menu_sel_cliente" class="select2bs4_customer" style="width: 100%;">
		<option value="0" selected disabled>--Seleziona cliente--</option>
		{% for i in clienti %}
		<option value="{{ i.id }}">{{i.ragionesociale }}&nbsp;-&nbsp;ID&nbsp;{{ i.id }}</option>
		{% endfor %}
		</select>
		</div>
		</div>
		
		
		<!-- Pulsantiera -->
		<table class="table table-bordered">
			<tbody>
			<tr>
			<td><label id="label_sel_cliente">Tutti i clienti</label></td>
			<td style="text-align:center;">
			<input type="checkbox" id="sel_cliente" checked="true" data-toggle="toggle" data-on="On" data-off="On" data-onstyle="success" data-offstyle="success" data-size="normal">
			</td>
			</tr>
			</tbody>
		</table>
			

		<!-- Pulsante-->
		<button class="btn btn-primary" id="submit">Add</button>
	
	</div>
	</form>
	  <!-- /.form group -->
	  
		</div>
		<!-- /.card-body -->
		
	  </div>
	  <!-- /.card -->
	  
	</div>
	 <!-- /.sticky-top mb-3 -->
	
  </div>
   <!-- /.col-md-3 -->
   
  <div class="col-md-9">
	<div class="sticky-top mb-3">
   <div class="card">
    <div class="card-header">
    <h4>Flussi in lavorazione</h4>
    </div>
	
	
	<div class="card-body">
		<table id="pending_table" class="table table-bordered table-hover">
		<thead>
		<tr>
		<th>ID</th>
		<th>Nome</th>
		<th>Documento</th>
		<th>Prossimo avvio</th>
		<th>Stato</th>
		</tr>
		</thead>
		<tbody>
		
	{% if tasks_pending %}
		{% for i in tasks_pending %}
		<tr>
		<td>{{ i.id }}</td>
		<td>{{ i.name }}</td>
		<td></td>
		<td>{{ i.next_run }}</td>
		
		<td><span class="badge bg-warning"><font size="3.1em">In attesa</font></span></td>
		</tr>
	{% endfor %}
	{% endif %}	
		
		</tbody>
		</table>
		</div>
		
		
	<!-- /.fine tabella risultati -->
	
							</div>
							<!-- /.card -->

						</div>
						<!-- /.sticky-top mb-3 -->
				
					</div>
					 <!-- /.col-md-3 -->
				
	  <div class="col-md-12">
	<div class="sticky-top mb-3">
   <div class="card">
    <div class="card-header">
    <h4>Flussi eseguiti</h4>
    </div>
	
	
	<div class="card-body">
		<table id="success_table" class="table table-bordered table-hover">
		<thead>
		<tr>
		<th>Nome</th>
		<th>Data esecuzione</th>
		<th>Stato</th>
		</tr>
		</thead>
		<tbody>
	{% if tasks_success %}
		{% for i in tasks_success %}
		<tr>
		<td>{{ i.group }}</td>
		<td>{{ i.started }}</td>
		<td><span class="badge bg-success"><font size="3.1em">Eseguito</font></span></td>
		</tr>
	{% endfor %}
	{% endif %}
		</tbody>
		</table>
		</div>
		

			</div>
			<!-- /.card -->

		</div>
		<!-- /.sticky-top mb-3 -->

	</div>
	 <!-- /.col-md-3 -->

</div>
				<!-- /.row -->

			</div>
			<!-- /.container-fluid -->

		</section>
		<!-- /.content -->
	
	</div>
	<!-- /.content-wrapper -->

<!-- FINE HTML -->



<!-- funzioni pulsanti -->
<script>
//VARIABILI GLOBALI*************************
	var codice_cliente = {};
	
//AL CARICAMENTO DELLA PAGINA*************************
	$(function () {
	
	//Set default value for codice_cliente
	codice_cliente = '0'
	
     //Initialize Select2 Elements
    $('.select2bs4_doc, .select2bs4_customer').select2({
	theme: 'bootstrap4',
	//allowClear: true,
    })

	//Nascondi div sel_cliente
	$(".togglediv_sel_cliente").hide();
	
});
	
//INIZIALIZZA DATATABLES***************************************
$(function () {
    $('#pending_table').DataTable({
	//$('#pending_table, #success_table').each(function(){
	//$(this).DataTable({
      "paging": true,
      "lengthChange": false,
      "searching": false,
      //"ordering": true,
	  //column index to be ordered
	  "order": [[ 2, "desc" ]],
      "info": true,
      "autoWidth": false,
      "responsive": true,
    });
	
	$('#success_table').DataTable({
      "paging": true,
      "lengthChange": false,
      "searching": false,
      //"ordering": true,
	  //column index to be ordered
	  "order": [[ 2, "desc" ]],
      "info": true,
      "autoWidth": false,
      "responsive": true,
    });
});

//AJAX FORM***************************************
  	$('#submit').click(function() {
	var titolo = document.getElementById('title').value;
	var data_avvio = document.getElementById('data_avvio').value;
	var start = document.getElementById('start').value;
	var end = document.getElementById('end').value;
	var all_customers = $('#sel_cliente').prop('checked');
	
	var data1 = {title: titolo, next_run: data_avvio, inizio: start, fine: end, tutti_clienti: all_customers, customer: codice_cliente};
	  $.ajax({
		url: '{% url 'todo:recur_form' %}',
		dataType: 'text',
		method: "POST",
		data : {
		csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
		data: JSON.stringify(data1),
		},
		success: function(data, status, xhr){
			//console.log(data);
			//console.log(data1);
			//console.log( JSON.stringify(data1));
		},
		error: function(xhr, status, error){
			//console.log(error);
			//console.log(data1);
			//console.log(xhr.responseText);
		}
	  });
	
	
	});
	
//PULSANTE SELEZIONA CLIENTE*************************
	$("#sel_cliente").change(function() {
	var stato_checkbox_sel_cliente = $('#sel_cliente').prop('checked')
	if(stato_checkbox_sel_cliente == false){
	$('#label_sel_cliente').text('Cliente singolo');
	$(".togglediv_sel_cliente").show();
	
	//PRENDI ID CLIENTE DA MENU SELECT***************************************
  	$('#menu_sel_cliente').change(function() {
	codice_cliente = $(this).val();  
    });
	
	}else{
	$('#label_sel_cliente').text('Tutti i clienti');
	$(".togglediv_sel_cliente").hide();
	codice_cliente = '0'
	}
	
});
</script>


{% endblock %}
