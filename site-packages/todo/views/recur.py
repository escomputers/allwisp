from django.shortcuts import render, get_object_or_404, redirect
from django.http import HttpResponse, Http404, HttpRequest
from django.contrib import messages
import json
from subprocess import Popen, PIPE
from datetime import datetime, timedelta
import time
from django.http import JsonResponse, HttpResponse, HttpResponseRedirect
from django.conf import settings
from django.template.loader import get_template, render_to_string
from django.contrib.auth.decorators import login_required, user_passes_test
from todo.utils import staff_check

from django.core.serializers import serialize
from django.forms.models import model_to_dict
from django.urls import reverse

from django_q.models import Schedule
from django_q.tasks import schedule, Schedule
from todo.forms import RecurForm

from django.utils import timezone

from django.core.cache import cache


@login_required
@user_passes_test(staff_check)
def recur(request):
    
    form = RecurForm(request.POST)

    if form.is_valid():
        form.save()
    
    try:
        data = Schedule.objects.filter(cluster='DjangORMcalendarApp')
        #for i in data:
        #    print(i.next_run)
    except Schedule.DoesNotExist:
        data = None
        
    return render(request, 'todo/recur.html', context={'schedules': data, 'form': RecurForm()})
