from django.http import HttpResponse, HttpResponseRedirect, JsonResponse
from django.shortcuts import get_object_or_404, render,redirect
from django.urls import reverse
from django.core.files.storage import FileSystemStorage
from django.contrib.auth.decorators import login_required
import datetime
from django.contrib import messages
from django.forms import formset_factory,modelformset_factory
from apps.customer.models import Customer
from apps.expenses.models import Expense
from apps.items.models import InvoiceItem
from dateutil.relativedelta import *
from ..models import Invoice,  Preventivo, Nota_di_credito,prodotti
from forms import offertainternetForm,visualizza_prodotti,cadenzapagamentoform, metodopagamento, offertavoipForm,prodotti_preventivoForm,nota_di_creditoForm,prodottiFormset


# Default invoice list, show 25 recent invoices
@login_required(login_url='login/')
def index(request):
    invoices = Invoice.objects.order_by('-date')[:25]
    context = {
		'title' : 'Recent Invoices',
        'invoice_list' : invoices,
    }
    return render(request, 'index.html', context)





# Print invoice
@login_required(login_url='login/')
def print_invoice(request, invoice_id):
    invoice = get_object_or_404(Invoice, pk=invoice_id)
    context = {
		'title' : "Invoice " + str(invoice_id),
	    'invoice' : invoice,
	}
    return render(request, 'print_invoice.html', context)




# Update invoice
@login_required(login_url='login/')
def update_invoice(request, invoice_id):
	invoice = get_object_or_404(Invoice, pk=invoice_id)
	try:
		invoice.date = datetime.datetime.strptime(request.POST['date'], "%d/%m/%Y")
		invoice.status = request.POST['status']
		invoice.save()
	except (KeyError, Invoice.DoesNotExist):
		return render(request, 'invoice.html', {
			'invoice': invoice,
			'error_message': 'Si Ã¨ verificato un problema, non sono stato in grado di aggiornare la fattura',
		})
	else:
		context = {
			'confirm_update' : True,
			'title' : 'Invoice ' + str(invoice_id),
			'invoice' : invoice,
			}
		return render(request, 'invoice.html', context)
