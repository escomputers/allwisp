{% extends "base.html" %} 
{% block content %}  
    <style>
      #result, #result_inst {
        border: 1px dotted #ccc;
        padding: 3px;
      }
      #result ul, #result_inst ul { 
        list-style-type: none;
        padding: 0;
        margin: 0;
      }
      #result ul li, #result_inst ul li {
        padding: 5px 0;
      }
      #result ul li:hover, #result_inst ul li:hover {
        background: #eee;
      }      
    </style>
	<body>
<div class="content-wrapper">

    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
  <h3 class="text-bold text-dark">Aggiungi cliente</h3>
</div>
</div>
  </div>
  </section>
			  
	<section class="content">
      <div class="container-fluid">		  
			  
       <form method="POST" action="">
      {% csrf_token %}

   <div class="card card-primary">
   
		<!-- sezione per errori form -->
		{% if clienti.errors %}
		 <div class="alert alert-danger" role="alert"> 
            <strong>{{ clienti.errors }}</strong>
		</div>
			
		{% endif %}
		
            <div class="card-header">
              <h5 class="text-bold text-bright">Dati anagrafici</h5>
            </div>
			
	<div class="card-body">

	  <div class="row">
		
		  <div class="alert alert-warning alert-dismissible">
			<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
			<p align="center">
			<h5><i class="icon fas fa-exclamation-triangle"></i>
			<b>
			{%if ultimoid.customer_id%}
			Ultimo ID</br>
			{{ultimoid.customer_id}}
			{%else%}
			{{ultimoid}}
			{%endif%}
			</b>
			</h5>
			</p>		
			</div>
		
		<!-- CUSTOMER ID -->
		<div class="col-sm-3">
		  <div class="card card-outline card-warning">
		  
				<div class="card-header">
				<h5 class="text-bold text-dark">ID</h5>
				</div>
			
				<div class="card-body">
					<div class="input-group mb-3">
					<input type="number" name="customer_id" class="form-control">
					</div>
				</div>

		  </div>
		</div>
		  
			<!-- CUSTOMER STATUS -->
			<div class="col-sm-3">
				  <div class="card card-outline card-warning">
				  
					<div class="card-header">
					<h5 class="text-bold text-dark">Stato</h5>
					</div>
					
					<div class="card-body">
						<div class="input-group mb-3">
							<select name="stato_cliente" class="select2" style="width: 100%;">
								<option></option>
								<option value="ACT">Attivo</option>
								<option value="PRO">Prospect</option>
								<option value="LEA">Lead</option>
								<option value="DEF">Defaulting</option>
							</select> 
						</div>
					</div>

				  </div>
			</div>
			
		<div class="col-sm-3">
	    <div class="card card-outline card-warning">
				  
		<div class="card-header">
		<h5 class="text-bold text-dark">Fatturazione</h5>
		</div>
					
		<div class="card-body">	
		
				<table class="table table-bordered">			
				<tbody>
				
				<tr>
				<td><label id="scelta_fattura">cortesia</label></td>
				<td style="text-align:center;">
				<input type="checkbox" name="scelta_fattura" id="scelta_fattura" data-toggle="toggle" data-on="On" data-off="Off" data-onstyle="success" data-offstyle="secondary" data-size="normal">
				</td>
				</tr>
				
				<tr>
				<td><label id="recur">ricorrente</label></td>
				<td style="text-align:center;">
				<input type="checkbox" name="recur" id="recur" data-toggle="toggle" data-on="On" data-off="Off" data-onstyle="success" data-offstyle="secondary" data-size="normal">
				</td>
				</tr>
	
				</tbody>
				</table>
			</div>

		</div>
	</div>
		  
  </div>
				
		
		<!-- -------------------DATI ANAGRAFICI-------------------------------->			  
	<div class="row">	
		<div class="col-sm-12">
			<div class="card card-outline card-primary">
				  

		<div class="card-body">
			<div class="row">
                  <div class="col-sm">
                    <div class="form-group">
                      <label for="ragionesociale">Ragione sociale</label> 
                      <input type="text" name="ragionesociale" id="ragionesociale" class="form-control">
                    </div>
                  </div>
                  
                  <div class="col-sm">
                    <div class="form-group">
                      <label for="piva">Partita IVA</label> 
                      <input type="text" name="piva" id="piva" class="form-control">
                    </div>
                  </div>
				  
                  <div class="col-sm">
                  <div class="form-group">
                    <label for="codice_univoco_sdi">Codice Univoco</label> 
                     <input type="text" name="codiceunivoco_sdi" id="codiceunivoco_sdi" class="form-control">
                  </div>
				  
                </div>
                  <div class="col-sm">
                    <div class="form-group">
                      <label for="codicefiscale">Codice Fiscale</label> 
                     <input type="text" name="codicefiscale" id="codicefiscale" class="form-control">
                    </div>
                  </div>
				  
               </div>
        
		<!-- Indirizzo fatturazione -->
        <div class="card">

				<div class="card-header">
				<div class="row">
			 
				<div class="col-sm-10">
			    <label>Indirizzo di fatturazione</label>
				</div>

				<!-- Pulsante copia indirizzo -->
				<div class="col-sm-2">
			    <input type="checkbox" id="copia_indirizzo_inst" checked data-toggle="toggle" data-on="Copia in indirizzo installazione" data-off="Copia in indirizzo installazione" data-onstyle="success" data-offstyle="secondary" data-width="250" data-height="35">
				</div>
				
			   </div>	
			   </div>
			   

                <!-- Campo ricerca indirizzo fatturazione --> 
				<div class="input-group">
				<input autocomplete="off" type="text" class="form-control" id="pois-search-term" placeholder="Ricerca indirizzo">
				
				<!-- Pulsante ricerca indirizzo fatturazione -->
				<button id="search-pois-button" class="btn btn-primary">
				<i class="fas fa-search" data-toggle="tooltip" title="Cerca"></i>
				</button>
				</div>
				
				 <!-- Div risultati ricerca indirizzo fatturazione --> 
				<div id="result"></div>
				
				 <!-- Mappa per indirizzo fatturazione--> 
			    <div id="map" style="height: 50vh;"></div>
				
	
				<!-- Campi indirizzo fatturazione -->		
				<div class="row">
					<div class="col-sm">
					<input type="text" name="indirizzo_res" id="indirizzo_res" class="form-control" placeholder="Indirizzo">
					</div>

					<div class="col-sm">
					<input type="text" name="comune_res" id="comune_res" class="form-control" placeholder="Citt&agrave;">
					</div>

					<div class="col-sm">
					<input type="text" name="cap_res" id="cap_res" class="form-control" placeholder="Cap">
					</div>

					<div class="col-sm">
					<input type="text" name="prov_res" id="prov_res" class="form-control" placeholder="Provincia">
					</div>
					
					<div class="col-sm">
					<input type="text" name="stato_res" id="stato_res" class="form-control" placeholder="Stato">
					</div>
	
				</div>
		
		</div>	  
        
		
		<!-- Indirizzo installazione -->
        <div class="form_indirizzo_inst">
		<div class="card">
			
			<div class="card-tools">
				<!-- Collapse Button -->
			    <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
			    </div>
			  
				<div class="card-header">
			    <label>Indirizzo di installazione</label>
				</div>
			
			<!-- Campo ricerca indirizzo installazione --> 
				<div class="input-group">
				<input autocomplete="off" type="text" class="form-control" id="pois-search-term_inst" placeholder="Ricerca indirizzo">
				
				<!-- Pulsante ricerca indirizzo installazione -->
				<button id="search-pois-button_inst" class="btn btn-primary">
				<i class="fas fa-search" data-toggle="tooltip" title="Cerca"></i>
				</button>
				</div>
				
				 <!-- Div risultati ricerca indirizzo installazione --> 
				<div id="result_inst"></div>
				
				 <!-- Mappa per indirizzo installazione--> 
			    <div id="map_inst" style="height: 50vh;"></div>
			
			
			<!-- Campi indirizzo installazione -->
			<div class="card-body">				
				<div class="row">
	
					<div class="col-sm">
					<input type="text" name="indirizzo_inst" id="indirizzo_inst" class="form-control" placeholder="Indirizzo"></td>
					</div>
					</td>

					<div class="col-sm">
					<input type="text" name="comune_inst" id="comune_inst" class="form-control" placeholder="Comune"></td>
					</div>

					<div class="col-sm">
					<input type="text" name="cap_inst" id="cap_inst" class="form-control" placeholder="Cap"></td>
					</div>

					<div class="col-sm">
					<input type="text" name="prov_inst" id="prov_inst" class="form-control" placeholder="Provincia"></td>
					</div>
					
					<div class="col-sm">
					<input type="text" name="stato_inst" id="stato_inst" class="form-control" placeholder="Stato"></td>
					</div>
					
				</div>
			 </div>
		</div>	
		</div>
                <div class="row">
				
                  <div class="col-sm">
                    <div class="form-group">
                      <label for="cel">Telefono</label> 
                      {{ clienti.recapito_tel}}
                    </div>
                  </div>
				  
                  <div class="col-sm">
                    <div class="form-group">
                      <label for="fax">FAX</label> 
                      {{ clienti.fax}}
                    </div>
                  </div>
				  
				  <div class="col-sm">
                    <div class="form-group">
                      <label for="email">Email</label> 
                      <input type="email" name="email" id="email" class="form-control">
                    </div>
                  </div>
				  
                  <div class="col-sm">
                    <div class="form-group">
                      <label for="pec">PEC</label> 
                     <input type="email" name="pec" id="pec" class="form-control">
                    </div>
                  </div>
				  
                </div>
				
                <div class="row">
				
                  <div class="col-sm">
                    <div class="form-group">
                      <label for="note">Note</label> 
                      {{ clienti.note}}
                    </div>
                  </div>
				  
                  <div class="col-sm">
                    <div class="form-group">
                      <label for="gps" >coordinate GPS</label> 
                      <input type="text" name="coordinate_gps" id="coordinate_gps" class="form-control">
                    </div>
                  </div>
				  
                </div>

				</div>
				<!-- card card-body -->

			</div>
			<!-- card card-outline card-primary -->
			
		</div>
		<!-- col-sm-12 -->
		
	</div>
	<!-- row col-sm-12 -->
	
	</div>
 <!-- card card-body dati anagrafici-->
 
</div>
<!-- card card-primary dati anagrafici -->
	
<!-- ##########################  CONDIZIONI CONTRATTUALI  ############################################# -->	  
	  <div class="card card-primary">
	  
		<div class="card-header">
		 <h5 class="text-bold text-bright">Condizioni contrattuali</h5>
		</div>
			
		<div class="card-body">
		
		 <div class="row">
		 
		 <!-- servizio primario -->
		  <div class="col-sm">
		  	<table class="table table-bordered">
				<thead>
				<tr class="table-primary">
				<th>Servizio primario</th>
				<th>Durata</th>
				<th style="width: 20px">Data attivazione</th>
				</tr>
				</thead>
				<tbody>
				
				<tr>
				
					<td>
					{{ clienti.offerta_internet}}
					</td>
					
					<td>
					<select name="durata_contratto" class="form-control">
					<option value="6">6 mesi</option>
					<option value="12">12 mesi</option>
					<option value="24">24 mesi</option>
					</select> 			  
					</td>
					
					<td>
					<input type="date" name="data_inizio_contratto" class="form-control pull-right">
					</td>
				
				</tr>
				
				</tbody>
				</table>
			
			
			<!-- servizi secondari -->
				<table class="table table-bordered">
				<thead>
				<tr class="table-secondary">
				<th>Servizi secondari</th>
				<th>Durata</th>
				<th style="width: 20px">Data attivazione</th>
				</tr>
				</thead>
				<tbody>
				
				<tr>
				
					<td>
					{{  clienti.offerta_voip }}
					</td>
					
					<td>
					<select name="durata_contratto" class="form-control">
					<option value="6">6 mesi</option>
					<option value="12">12 mesi</option>
					<option value="24">24 mesi</option>
					</select> 			  
					</td>
					
					<td>
					<input type="date" name="data_inizio_contratto" class="form-control pull-right">
					</td>
				
				</tr>
				
				</tbody>
				</table>
		 </div>
		
		<!-- importi aggiuntivi prima fattura -->		
		<div class="col-sm">
			<div class="form-group">
			<label for="aggiungi_extra">Aggiungi extra in prima fattura</label>
			{{ clienti.offerta_extra}}
			</div>
		</div>	
			
		</div>
		
             
	</div>
	<!-- card card-body -->
	 
</div> 
 <!-- card card-primary -->		
		
<!-- ##########################  DATI PAGAMENTO  ############################################# -->	  
			
	<div class="card card-primary">
	
            <div class="card-header">
              <h5 class="text-bold text-bright">Dati di pagamento</h5>
            </div>
			
    <div class="card-body">
			
        <div class="row">
		
			<div class="col-sm">
			  <div class="form-group">
				<label for="cadenza_pagamento">Cadenza pagamento</label> 
			   {{ clienti.cadenza_pagamento}}
			   </div>
			
			
			
			<table class="table table-bordered">

			<tbody>
			
				<tr>
				<td><label for="pagamento_anticipato">Anticipato</label>
				</td>
				<td style="text-align:center;">
				<input type="checkbox" id="pagamento_anticipato" data-toggle="toggle" data-on="On" data-off="Off" data-onstyle="success" data-offstyle="secondary" data-size="small">
				</td>
				</tr>
				
				<tr class="richiesta_calcolo_iniziale">
				<td><label for="richiesta_calcolo_iniziale">Aggiungi giorni in prima fattura</label></td>
				<td style="text-align:center;">
				<input type="checkbox" id="richiesta_calcolo_iniziale" data-toggle="toggle" data-on="On" data-off="Off" data-onstyle="success" data-offstyle="secondary" data-size="small">
				</td>
				</tr>
				
				<tr>
				<td><label for="spese_incasso">Spese incasso</label>
				</td>
				<td style="text-align:center;">
				<input type="checkbox" id="spese_incasso" data-toggle="toggle" data-on="On" data-off="Off" data-onstyle="success" data-offstyle="secondary" data-size="small">
				</td>
				</tr>
				

			
			</tbody>
			</table>

		  </div>
		  
		  
		  	<div class="col-sm">
			  <div class="form-group">
				<label for="metodo_pagamento">Metodo di pagamento</label> 
				{{ clienti.metodo_pagamento}}
			  </div>
			  
			  			<div class="spese_incasso">
			  <div class="col-sm">	
			  <div class="form-group">
				<label for="spese_riscossione">Spese incasso</label> 
				{{ clienti.spese_invio_bolletta}}
			  </div>
		      </div>
			</div>
			  
			  
			</div>
			
		</div> 
		
	
		</div> 
	 <!-- card card-body -->		
	 
</div> 
 <!-- card card-primary -->		
 
<!-- ##########################  DATI CONNESSIONE  ############################################# -->	 
		
	<div class="card card-primary">
	
            <div class="card-header">
              <h5 class="text-bold text-bright">Dati di connessione</h5>
            </div>
			
            <div class="card-body">
			
              <div class="row">
			  
			  <div class="col-sm-2">
                  <div class="form-group">
                    <label for="pppoe_user">Utente PPPOE</label> 
                 <input type="text" id="pppoe_user" class="form-control">
                  </div>
                </div>
			  
				<div class="col-sm-2">
                  <div class="form-group">
                    <label for="nodo">Nodo</label> 
                    {{ clienti.nodo}}
                  </div>
                </div>
				
                <div class="col-sm-2">
                  <div class="form-group">
                    <label for="ip">Indirizzo IP</label> 
                    {{ clienti.ip_statico}}
                  </div>
                </div>
				
                <div class="col-sm-2">
                  <div class="form-group">
                    <label for="mac adress">MAC address</label> 
                    {{ clienti.mac_adress}}
                  </div>
                </div>
				
            </div>
		
           <div class="row">
			  <!--
			  <button type="button" type="submit" name="submit" value="Submit" class="btn btn-success btn-lg">Salva</button>     
			  -->
			   <input type="submit" value='Submit' name="submit" class="btn btn-success"/>
			</div>
			
		</form> 
		
	</div> 
	 <!-- card card-body -->		
	
</div> 
<!-- card card-primary -->
				
<!-- ############################################################################################# -->	 

	</div>
	<!-- col-xl-12 -->
	
	</div>
	<!-- container-fluid -->
	
  </section>
  <!-- section class="content" -->
  
</div>
<!-- content-wrapper -->



<script>

//*************************AL CARICAMENTO DELLA PAGINA*************************
	$(function () {
	
	//Inizializza bootstrap-duallistbox
	$(".duallistbox").bootstrapDualListbox({
	});
	
	//Inizializza Select2
	$(".select2").select2({
	placeholder: "Seleziona",
    allowClear: true,
	theme: "bootstrap4"
	});
	
	//Nascondi-Mostra campi di default
	$(".form_indirizzo_inst").hide();
	$(".richiesta_calcolo_iniziale").hide();
	$(".spese_incasso").hide();
	$("#map").hide();
    $("#map_inst").hide();
	
	});

//******************* TOGGLE SPESE INCASSO ********************	

	$('#spese_incasso').change(function() {
	let stato_checkbox_spese_incasso = $('#spese_incasso').prop('checked')

	if(stato_checkbox_spese_incasso == true){
	$(".spese_incasso").show();
	}else{
	$(".spese_incasso").hide();
	}

	});

//******************* TOGGLE PAGAMENTO ANTICIPATO ********************	

	$('#pagamento_anticipato').change(function() {
	let stato_checkbox_pagamento_anticipato = $('#pagamento_anticipato').prop('checked')

	if(stato_checkbox_pagamento_anticipato == true){
	$(".richiesta_calcolo_iniziale").show();
	}else{
	$(".richiesta_calcolo_iniziale").hide();
	}

	});
//******************* TOGGLE COPIA IN INDIRIZZO INSTALLAZIONE********************
	
	$('#copia_indirizzo_inst').change(function() {
	let stato_checkbox_copia_indirizzo_inst = $('#copia_indirizzo_inst').prop('checked')

	if(stato_checkbox_copia_indirizzo_inst == false){
	$(".form_indirizzo_inst").show();
	}else{
	$(".form_indirizzo_inst").hide();
	}

	});
</script>


<script>
//*************************GESTIONE MAPPA E CAMPO INDIRIZZO FATTURAZIONE*************************

// Use Signer from @aws-amplify/core
const { Signer } = window.aws_amplify_core;

// AWS Resources
// Cognito:
const identityPoolId = "eu-central-1:0155dfbd-31ca-43ca-86ec-ece0b638d417";
// Amazon Location Service resource names:
const mapName = "explore.map.def";
const placesName = "defaultidx";

// Extract the region from the Identity Pool ID
AWS.config.region = identityPoolId.split(":")[0];

// Instantiate a Cognito-backed credential provider
const credentials = new AWS.CognitoIdentityCredentials({
  IdentityPoolId: identityPoolId,
});

// Sign requests made by MapLibre GL JS using AWS SigV4:
function transformRequest(url, resourceType) {
  if (resourceType === "Style" && !url.includes("://")) {
    // Resolve to an AWS URL
    url = `https://maps.geo.${AWS.config.region}.amazonaws.com/maps/v0/maps/${url}/style-descriptor`;
  }

  if (url.includes("amazonaws.com")) {
    // Sign AWS requests (with the signature as part of the query string)
    return {
      url: Signer.signUrl(url, {
        access_key: credentials.accessKeyId,
        secret_key: credentials.secretAccessKey,
        session_token: credentials.sessionToken,
      }),
    };
  }

  // If not amazonaws.com, falls to here without signing
  return { url };
}

// Initialize a map
function initializeMap() {
  // Load credentials and set them up to refresh
  credentials.getPromise();
  
  // Initialize the map
  const mlglMap = new maplibregl.Map({
    container: "map", // HTML element ID of map element
    center: [9.7779012, 43.4572162], // Initial map centerpoint
    zoom: 4, // Initial map zoom
    style: mapName,
    transformRequest,
  });

  // Add navigation control to the top left of the map
  mlglMap.addControl(new maplibregl.NavigationControl(), "top-left");
  
  return mlglMap;
}


async function main() {
  // Initialize map and AWS SDK for Location Service:
  
  const location = new AWS.Location({credentials, region: AWS.config.region});
  searchPoisTermTextBox = document.getElementById('pois-search-term');
  searchPoisButton = document.getElementById('search-pois-button');
  poiMarker = null;

  //***********FUNZIONE DI RICERCA SU "SUBMIT" CAMPO INDIRIZZO FATTURAZIONE*****************
  this.searchPoisButton.onclick = (e) => {
  e.preventDefault();
  $("#map").show();
  const map = initializeMap();
  const term = this.searchPoisTermTextBox.value.trim();
  
  // Set up parameters for search call
  let params = {
  Text: term,
  IndexName: placesName,
  };

  location.searchPlaceIndexForText(params, function(err, data) {
  if (err) {
  alert("There was an error searching.");
  } else {
 
  // Remove the previous marker
  if (poiMarker != null) {
  poiMarker.remove();
  poiMarker = null;
  }
  //Add new marker if there's at least one result
  const marker = new maplibregl.Marker().setLngLat(data.Results[0].Place.Geometry.Point).addTo(map);
  poiMarker = marker;
  map.flyTo({
  center: data.Results[0].Place.Geometry.Point,
  zoom: 16
  });
  poiMarker.setPopup(new maplibregl.Popup({className: 'my-class'}).setHTML("<h5>" + data.Results[0].Place.Label + "</h5>"))
  
//*************************RIEMPI CAMPI DOPO IL CLICK SUL PULSANTE CERCA INDIRIZZO FATTURAZIONE *************************
  let addressNumber = data.Results[0].Place.AddressNumber
  if (typeof addressNumber == 'undefined') { addressNumber = 'N/A'}
  $('input#indirizzo_res').val(data.Results[0].Place.Street + ' ' + addressNumber);
  $('input#comune_res').val(data.Results[0].Place.Municipality);
  $('input#cap_res').val(data.Results[0].Place.PostalCode);
  $('input#prov_res').val(data.Results[0].Place.SubRegion);
  $('input#stato_res').val(data.Results[0].Place.Country);
  
  }
  });
  
};

//***********FUNZIONE SUGGERIMENTI RICERCA SU "KEYUP" CAMPO INDIRIZZO FATTURAZIONE *****************  
  this.searchPoisTermTextBox.onkeyup = (e) => {
  e.preventDefault();
  
  const term = this.searchPoisTermTextBox.value.trim();
  
  // Set up parameters for search call
  let params = {
  Text: term,
  IndexName: placesName,
  Language: "it",
  //MaxResults: "5"
  };

  location.searchPlaceIndexForSuggestions(params, function(err, data) {
  const res = document.getElementById("result");
  
  res.innerHTML = '';
  let list = '';
  for (let i = 0; i < data.Results.length; i++) {
  list += `<li data-value="${data.Results[i].Text}">${data.Results[i].Text}</li>`;
  }
  res.innerHTML = `<ul id="autocompletedlist">${list}</ul>`;
  document.getElementById("autocompletedlist").addEventListener('click', function(e) {
  
  // e.target is our targetted element.
  if(e.target && e.target.nodeName == 'LI') {
  document.getElementById('pois-search-term').value = e.target.getAttribute('data-value');
  document.getElementById('result').innerHTML = '';
  
  }
  });
 });
 }
 
}
main();
</script>


<script>
//*************************GESTIONE MAPPA E INDIRIZZO INSTALLAZIONE*************************

// Initialize a map
function initializeMap_inst() {
  // Load credentials and set them up to refresh
  credentials.getPromise();
  
  // Initialize the map
  const mlglMap_inst = new maplibregl.Map({
    container: "map_inst", // HTML element ID of map element
    center: [9.7779012, 43.4572162], // Initial map centerpoint
    zoom: 4, // Initial map zoom
    style: mapName,
    transformRequest,
  });

  // Add navigation control to the top left of the map
  mlglMap_inst.addControl(new maplibregl.NavigationControl(), "top-left");
  
  return mlglMap_inst;
}


async function main_inst() {
  // Initialize map and AWS SDK for Location Service:
  
  const location_inst = new AWS.Location({credentials, region: AWS.config.region});
  searchPoisTermTextBox_inst = document.getElementById('pois-search-term_inst');
  searchPoisButton_inst = document.getElementById('search-pois-button_inst');
  poiMarker_inst = null;

  //***********FUNZIONE DI RICERCA SU "SUBMIT" CAMPO INDIRIZZO INSTALLAZIONE *****************
  this.searchPoisButton_inst.onclick = (e) => {
  e.preventDefault();
  $("#map_inst").show();
  const map_inst = initializeMap_inst();
  const term_inst = this.searchPoisTermTextBox_inst.value.trim();
  
  // Set up parameters for search call
  let params_search_inst = {
  Text: term_inst,
  IndexName: placesName,
  };

  location_inst.searchPlaceIndexForText(params_search_inst, function(err, data) {
  if (err) {
  alert("There was an error searching.");
  } else {
 
  // Remove the previous marker
  if (poiMarker_inst != null) {
  poiMarker_inst.remove();
  poiMarker_inst = null;
  }
  //Add new marker if there's at least one result
  const marker_inst = new maplibregl.Marker().setLngLat(data.Results[0].Place.Geometry.Point).addTo(map_inst);
  poiMarker_inst = marker_inst;
  map_inst.flyTo({
  center: data.Results[0].Place.Geometry.Point,
  zoom: 16
  });
  poiMarker_inst.setPopup(new maplibregl.Popup({className: 'my-class'}).setHTML("<h5>" + data.Results[0].Place.Label + "</h5>"))
  
//*************************RIEMPI CAMPI DOPO IL CLICK SUL PULSANTE CERCA INDIRIZZO INSTALLAZIONE*************************
  let addressNumber = data.Results[0].Place.AddressNumber
  if (typeof addressNumber == 'undefined') { addressNumber = 'N/A'}
  $('input#indirizzo_inst').val(data.Results[0].Place.Street + ' ' + addressNumber);
  $('input#comune_inst').val(data.Results[0].Place.Municipality);
  $('input#cap_inst').val(data.Results[0].Place.PostalCode);
  $('input#prov_inst').val(data.Results[0].Place.SubRegion);
  $('input#stato_inst').val(data.Results[0].Place.Country);
  
  }
  });
  
};

//***********FUNZIONE SUGGERIMENTI RICERCA SU "KEYUP" CAMPO INDIRIZZO INSTALLAZIONE*****************  
  this.searchPoisTermTextBox_inst.onkeyup = (e) => {
  e.preventDefault();
  
  const term_inst = this.searchPoisTermTextBox_inst.value.trim();
  
  // Set up parameters for search call
  let params_suggest_inst = {
  Text: term_inst,
  IndexName: placesName,
  Language: "it",
  //MaxResults: "5"
  };

  location_inst.searchPlaceIndexForSuggestions(params_suggest_inst, function(err, data) {
  const res_inst = document.getElementById("result_inst");
  res_inst.innerHTML = '';
  let list_inst = '';
  for (let i = 0; i < data.Results.length; i++) {
  list_inst += `<li data-value="${data.Results[i].Text}">${data.Results[i].Text}</li>`;
  }
  res_inst.innerHTML = `<ul id="autocompletedlist_inst">${list_inst}</ul>`;
  document.getElementById("autocompletedlist_inst").addEventListener('click', function(e) {
  
  // e.target is our targetted element.
  if(e.target && e.target.nodeName == 'LI') {
  document.getElementById('pois-search-term_inst').value = e.target.getAttribute('data-value');
  document.getElementById('result_inst').innerHTML = '';
  
  }
  });
 });
 }
 
}
main_inst();
</script>

{% endblock %}