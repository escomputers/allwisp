{% extends 'base.html' %}

{% block content %}






<style type="text/css">
  .btn-purple, .btn-purple:hover, .btn-purple:active, .btn-purple:visited {
    background-color: #800080 !important;
    color: #ffffff;
}

 .big-checkbox {width: 30px; height: 30px;}

 .fielddatedisable { border: 0 !important; background-color: white !important;}



</style>
<style> 
#prezzo_subtot {
 color: black;
}

#prezzo_subtot::placeholder {
  color: black;
}

#total {
  color:black;
}

#total::placeholder {
  color: black;
}

input. {
  background: white;
  outline: none;
  border: none;
}

</style>
{% if error_message %}

<div class="alert alert-danger">{{ message }}</div>

{% endif %}

<div class="content-wrapper">
  <section class="content-header">
    <div class="container-fluid">


{% if invoice %}

  <!-- Content Wrapper. Contains page content. Contiene intestazione   -->

      </div><!-- /.container-fluid -->
    </section>

    <section class="content">
      <div class="container-fluid">
        <div class="card card-primary">
    <div class="card-header">

  <h2 class="card-title"><a id="tipo_documento">{{documento}}</a> n. {{invoice.preventivo_id}}</h2>
</div>

<div class="card-body">
<form action="" method="post">
        {% csrf_token %}
        
        <div class="row">
          <div class="col-12">
            <div class="callout callout-info">
              <h5><i class="fas fa-info"></i> Nota:</h5>
              Stai creando il preventivo. Ricordati di selezionare la scadenza dell'offerta, altrimenti di default sarà 30 giorni dalla data corrente
            </div>
          </div>
        </div>


            <!-- Main content -->
            <div class="invoice p-3 mb-3">
              <!-- title row -->
              <div class="row">
                <div class="col-8">
                  <h4><i><img alt="logo_cliente" src="/static/images/logocliente.png" width="80px"/></i></h4>
                   </div>
                   <br>
                   <br>
                   <br>
                   <br>
                </div>
                <br>
                <!-- /.row -->
                <br>
            
              <!-- info row -->
              <div class="row invoice-info">
                <div class="col-sm-4 invoice-col">
                  <h6><strong> Emesso da:</strong></h6>
                  <address>
                    <strong>Arpanet Italia s.r.l,</strong><br>
                    <strong>Adress:</strong>Via Caldera 21<br>
                    <strong>City.</strong>Milano, Mi<br>
                    <strong>zip.</strong>20153,&nbsp;Italy<br>
                    <strong>Tel:</strong>&nbsp; (804) 123-5432<br>
                    <strong>P.iva:</strong>&nbsp; It0121234551<br>
                    <strong>Email:</strong>&nbsp; info@arapnetitalia.com
                  </address>
                </div>
                <!-- /.col -->
                <div class="col-sm-4 invoice-col">
                  <h6><strong>Cliente:</strong></h6>
                  <address>
                    <strong>Customer:</strong>&nbsp;&nbsp;{{invoice.customer.ragionesociale}}<br>
                    <strong>adress:</strong> &nbsp;{{invoice.customer.indirizzo_res}}<br>
                   <strong>city:</strong> &nbsp;{{invoice.customer.comune_res}},&nbsp;&nbsp;{{invoice.customer.prov_res}},<br><strong>zip:&nbsp;</strong>{{invoice.customer.cap_res}},&nbsp; Italy<br>
                    <strong>tel:</strong>&nbsp;{{invoice.customer.recapito_tel}},&nbsp;&nbsp; <strong>Fax:&nbsp;</strong>{{invoice.customer.fax|default_if_none:''}}
                    <br>
                    {% if invoice.customer.piva %}
                     <strong>vat:</strong> &nbsp;{{invoice.customer.piva}},&nbsp;&nbsp;<br>
                     {% else %}
                     <strong>Tax id:</strong> &nbsp;<strong> <font color="#152238">{{invoice.customer.codicefiscale}},&nbsp;&nbsp;</font></strong><br>
                     {% endif %}
                    <a id="email_cliente" value="{{invoice.customer.email}}"><strong>Email:&nbsp;</strong>{{invoice.customer.email}}</a>  
                    <a id="pec_cliente" value="{{invoice.customer.pec}}">, <strong>Pec:&nbsp;</strong>{{invoice.customer.pec}}</a>
                  </address>
                </div>
                <!-- /.col -->
                <div class="col-sm-4 invoice-col">
                  <h4><b>{{documento}} numero. {{invoice.preventivo_id}} </b><br></h4>
               <div class="form-group form-inline"> 
         <label ><font color="#0275d8">Data emissione:&nbsp;</font></label>     
        <input type="text" class="form-control  font-weight-bold text-primary fielddatedisable "  disabled id="invoicedate" value="{{ invoice.date|date:'d-m-Y' }}" size="6">
        </div>
                  <div class="form-group form-inline" id="scadenza_documento">
              <label class="col-xs-3 control-label" id="titolo_scadenza_documento"><font color="red">Scadenza fattura:</font></label>&nbsp;
               <div class="col-xs-2">
        <select id="selezionascadenza" name="selezionascadenza" class="form-control  font-weight-bold text-danger" style="width:auto;"><option value="0">Data emissione documento</option><option value="15 ">15 giorni emissione documento</option><option  value="30"  selected>30 giorni emmissione documento</option><option value="60">60 giorni emissione documento</option><option value="90">90 giorni emissione documento</option></select>
      </div>
    </div>


      </div>
                <!-- /.col -->
    </div>
              <!-- /.row -->
<br>
<br>
<br>
<br>
<!-- Table row -->
<div class="row mb-2">
  <div class="col-3">

  <label>Sconto in percentuale</label>
      <input type="checkbox" id='checkbox_sconto' checked="true" data-on="€" data-off="%" data-toggle="toggle" data-size="small" data-offstyle="info"/>
      <label>Sconto in unità</label>
<br>
<br>
  </div>


  <div class="col-12 table-responsive">

    <table  id="tbl_posts" class="table table-bordered ">
      <thead >
      <tr class="table-secondary">
       <th>modifica</th>
        <th>Prodotto</th>
        <th>Descrizione</th>
        <th>Quantità</th>
        <th>Prezzo</th>
        <th>Sconto</th>
        <th>Prezzo sub.totale</th>
        <th>Tax %</th>
        <th>Totale</th>
        <th>Elimina</th>
    </tr>
  </thead>
{{ formset.management_form }}
       
 {{ formset.non_form_errors }}      
{% for form in formset %}

<tbody id="tbl_posts_body" >
    
      <tr id="rec-1" class="tr_tabella">
        <td>

          <input type="checkbox" class="checkbox_abilita" checked/><a style="padding-right:15px;"><i><img alt="modifica" src="/static/images/icon-pen.svg" width="32px" title="fai click nella checkbox"></i></a></td>
        <td>  {{form.prodotto}}</td>
        <td>  {{form.descrizione}}</td>
        <td>  {{form.quantita}}</td>
        <td>  {{form.prezzo}}</td>
        <td>  {{form.sconto}}</td>
        <td>  {{form.prezzo_sub_tot}}</td>
        <td>{{form.tax}}</td>
       <td hidden >{{form.tipo_di_sconto}}</td>

        <td>{{form.totale}}</td>
    <td> <a>{{ form.DELETE }}</a></td>
     </tr>

</tbody>
   {% endfor %}
    
 </table>

  </div>

</div>
                <!-- /.col -->
              <!-- /.row -->           <!--aggiunge crd per le righe della fattura-->


  <br>
    <div class="row">
    <div class="col-sm-12">
      <label>Note</label>
      <textarea class='md-textarea form-control note' cols="330" id='note' rows='2'></textarea>
    </div>
  </div>


<br>
<br>

<div class="row">
<div class="col-sm-4">
  <h5>Altre voci preventivo</h5>
</div>
</div>

<div class="row">
<div class="col-12 table-responsive">
  <table class="table table-stripe">

  <tfoot>
    <tr>
    <th>Spese spedizione</th>
    <th>Altri oneri</th>
    <th>Descrizione altri oneri</th>
</tr>
<tr class="colorefootable">  
<td><input type="number" title="inserisci solo numeri" oninput="validity.valid||(value='');" min="0" id="spese_spedizione" value="0.00" name="spese_spedizione" class="spese_spedizione form-control"/></td>

<td><input type="number" title="inserisci solo numeri" oninput="validity.valid||(value='');" min="0" id="altri_oneri_fattura"   value="0.00" name="altri_oneri" class="altri_oneri_fattura form-control"/></td> 
<td id="descrizioneoneri"><textarea class='md-textarea form-control altri_oneri_descrizione' id='altri_oneri_descrizione'  name="descrizione_altri_oneri" value="Non dichiarato" disabled="true" cols='100' rows='2'></textarea></td> 


</tr>
</tfoot>


</table>


</div>
</div>

<br>
<br>
<br>
<br>
  <div class="row">
        <!-- accepted payments column -->
        <div class="col-6 ">
          <p class="lead">Metodi di pagamento:</p>
          <img src="/static/images/visa.png" alt="Visa">
          <img src="/static/images/mastercard.png" alt="Mastercard">
          <img src="/static/images/american-express.png" alt="American Express">
          <img src="/static/images/paypal2.png" alt="Paypal">
          <p class="text-muted well well-sm shadow-none" style="margin-top: 10px;">
            Il pagamento dovrà effettuarsi con i metodi sopra elencati, salvo che non sia previsto come metodo di pagamento l'accredito in un conto corrente
          </p>
        </div>

        <!-- /.col -->
        <div class="col-4 ml-auto">
          <h5 class="lead text-danger" >Scadenza preventivo <input id="scadenza" class="fielddatedisable lead text-danger" name="scadenza_fattura" value=""></h5>
          <div class="table-responsive">
            <table class="table">
              <tr>
                <th style="width:50%">Totale tasse escl.€</th>
                <td ><input id="tasse_escluse" class="fielddatedisable" name="totale_fattura_tasse_escluse" value="0.00"></td>

              </tr>
              <tr>
                <th>Iva €</th>
                <td ><input id="tot_iva" class="fielddatedisable" name="totale_iva_fattura" value="0.00"></td>
              </tr>
              <tr>
                <th>Costo spedizione €</th>
                <td > <input id="cost_spedizioni" class="fielddatedisable" name="spese_spedizione" value="0.00"></td>
              </tr>
              <tr>
                <th>Altri oneri €</th>
                <td id="altri_oneri"> 0.00</td>
              </tr>
              <th>Sconto applicato €</th>
              <td > <input id='sconto_applicato' class="fielddatedisable" name="totale_sconto_applicato_fattura" value="0.00"></td>
              <tr>
                <th>Totale: €</th>
                <td><strong><input id="totale_della_fattura" class="fielddatedisable" name="totale_fattura" value="0.00"></strong></td>
              </tr>
            </table>
          </div>
                </div>
                <!-- /.col -->
              </div>
              <!-- /.row dlla tabella riepilogo -->

              <!-- this row will not appear when printing -->
              <div class="row no-print">
                <div class="col-12">
                  <a href="invoice-print.html" rel="noopener" target="_blank" class="btn btn-default"><i class="fas fa-print"></i> Print</a>
                  <button type="button" class="btn btn-warning float-right"><i class="far fa-credit-card"></i> Submit Payment
                  </button>

                  <button type="button" class="btn btn-primary float-right" style="margin-right: 5px;">
                    <i class="fas fa-download"></i> Generate PDF
                  </button>
                   <button  value="submit" type="Submit" class="btn btn-purple float-right" id ="send_invoice" style="margin-right: 5px;">
                    <i class="fas fa-file-invoice"></i> Salva preventivo
                  </button>
                </div>
              </div>
            
            </div>
            <!-- /.invoice -->
          </div><!-- /.col -->
      </div>
    </form>

  </div>
</div>
    </div>
  </section>
</div>
       <!-- /.row -->
    <!-- /.content -->

<div id="empty_form" style="display:none">
 <tr  class="tr_tabella">
        <td><input type="checkbox" class="checkbox_abilita" checked/><a style="padding-right:15px;"><i><img alt="modifica" src="/static/images/icon-pen.svg" width="32px" title="fai click nella checkbox"></i></a></td>
        <td>  {{formset.empty_form.prodotto}}</td>
        <td>  {{formset.empty_form.descrizione}}</td>
        <td>  {{formset.empty_form.quantita}}</td>
        <td>  {{formset.empty_form.prezzo}}</td>
        <td>  {{formset.empty_form.sconto}}</td>
        <td>  {{formset.empty_form.prezzo_sub_tot}}</td>
        <td>{{formset.empty_form.tax}}</td>
       
       <td hidden >{{formset.empty_form.tipo_di_sconto}}</td>

        <td>{{formset.empty_form.totale}}</td>
    <td> <a class="btn add-form-row"><i><img alt="aggiungi riga" src="/static/images/cestino.svg" width="25px" title="aggiungi riga"></i></a></td>
     </tr>
</div>




 

<script type="text/javascript"> //al caricamento
$(function() {//al caricamento

  //----------------- titoli e colorazione tipo fattura e scadenza-----------------------
  
  var tipo_documento = $('#tipo_documento').text();
 
  if(tipo_documento == "Nota di credito")
 


  {
    
    $('#scadenza_documento').hide()

  }


  else if(tipo_documento == "Preventivo"){
    $('#titolo_scadenza_documento').text('Scadenza preventivo')
    $('#titolo_scadenza_documento').css("color","red")
   
 
  };//----------------------fine------------------------

    


//-----------------------per il calcolo della scadenza fattura--------------------------

  var options0 = { year: 'numeric', month: 'numeric', day: 'numeric' }
   var selezione_scadenza0=parseInt($('#selezionascadenza').val());
   var date=new Date();
   date.setDate(date.getDate() + selezione_scadenza0);
   var data_formattata=date.toLocaleDateString("it-IT", options0);
   $('#scadenza').val(data_formattata)
   $('#invoicedate').text(date)
   

   $('#selezionascadenza').change(function(){
   var scadenza=new Date();
   var selezione_scadenza=parseInt($('#selezionascadenza').val());
   var options = { year: 'numeric', month: 'numeric', day: 'numeric' };//se si usa long(al posto del numeric si vedrà il nome corrispondente), si può mettere weekday per sapere il giorno della data

   scadenza.setDate(scadenza.getDate() + selezione_scadenza);
   var a=scadenza.toLocaleDateString("it-IT", options);
   $('#scadenza').val(a)

  });//----------fine caloclo scadenza fattura--------------
  
});//fine caricamento pagina
</script>


<script type="text/javascript">//aggiungi form

  
$(document).delegate('a.delete-record', 'click', function(e) {// per rimuovere la riga
     e.preventDefault();    
     var didConfirm = confirm("Sei sicuro di volere eleminare questa riga?");
      if (didConfirm == true) {
      var id = jQuery(this).attr('data-id');
      var targetDiv = jQuery(this).attr('targetDiv');
      jQuery('#rec-' + id).remove();

   //inizio calcolo tabella   quando si elimina elemento
   var spese_spedizione=parseFloat($('#spese_spedizione ').val());
   var altrioneri_fattura=parseFloat($('#altri_oneri_fattura ').val());

var quotasubtot=0
var totalesconto=0
var totaleconiva=0


   $(".prezzo_sub_tot").each(function(){//calcolo del subtotale
      quotasubtot += +$(this).val();
      val_finale_prezzo_sub_tot += $(this).val()+separatore;
     
    });


    $(".totale").each(function(){//calcolo del totale
        totaleconiva += +$(this).val();
    });

    var totaleiva=totaleconiva-quotasubtot//calcolo quota iva
        
    $('#tbl_posts_body tr').each(function(index) {// per rigenerare l'indice dei prodotti
      $(this).find('span.sn').html(index+1);
       });
       return true;
        } else {
        return false;
        }
  
  var totale = totaleconiva + altrioneri_fattura + spese_spedizione
//visualizzazione nella tabella riepilogativa
  $("#cost_spedizioni").val(spese_spedizione);
    $("#altri_oneri").text(altrioneri_fattura);
    $("#tasse_escluse").val(quotasubtot);
    $("#tot_iva").val(totaleiva);
    $("#totale_della_fattura").val(totale)
});
</script>

<script type="text/javascript">//per abilitare e disabilitare i campi delle righe

$('tr td:first-child input[type="checkbox"]').click(function() {
   //enable/disable all except checkboxes, based on the row is checked or not
   avviso_disabilitazione=$(this).closest('tr').find(":input:first").prop('checked')//questo serve per ricordare di disabilitare la riga quando si finisce la modifica
  if(avviso_disabilitazione==true){
    var newLine = "\r\n"
    var msg = "Attenzione!"
    msg += newLine;
    msg += newLine;
    msg += "Quando modifichi devi stare attento al selezionatore dello sconto perché sarà calcolato in base allo stato attuale!";
    msg += newLine;
    msg += newLine;
    msg += "Ricordati di disabilitare la riga quando finisci le modifiche!";
   
    alert(msg);
   }
   $(this).closest('tr').find(":input:not(:first)").attr('disabled', !this.checked);
   
});





</script>


<script type="text/javascript">// quando si cambia il valore di input tabella

$('table').on('change keyup', 'input', function(){ //diversi venti insieme si possono inserire tra virgolette e divisi dallo spazio
// fare ogni volta che cambia il valore die campi
  
  thisRow = $(this).parent().parent();//prende la riga della tabella
   var quantita  = parseFloat(thisRow.find('td > .quantita').val());   // trova il valore di quantità
    var prezzo = parseFloat(thisRow.find('td > .prezzo').val()); // trova il valore di prezzo(di ogni prezzo)
    var iva = parseFloat(thisRow.find('td > .tax').val());//trova il valore dell'iva
    var sconto=parseFloat(thisRow.find('td > .sconto').val());//trova il valore dello sconto
    var toggle_sconto=$('#checkbox_sconto').prop('checked');

    thisRow.find('td>.totale').val('');//azzera il valore di totale
    
    thisRow.find('td>.prezzo_sub_tot').val('');//azzera il valore di prezzo_sub_totale
    
    var subtotaleriga=(prezzo*quantita)
    

    if(toggle_sconto ==true){
      var sconto_effettivo=sconto
      var sconto_tipo='€'

      
    }
    
    else{
      var sconto_effettivo =(subtotaleriga*sconto)/100
      var sconto_tipo='%'
    }


    var prova=(prezzo*quantita)-sconto_effettivo
    
    var percento=(prova*iva)/100
   
    var totaleriga=prova+percento
    thisRow.find('td>.sconto_valore').val(sconto_effettivo);
    thisRow.find('td>.prezzo_sub_tot').val(prova);
    thisRow.find('td>.totale').val(totaleriga);
    thisRow.find('td >.sconto_tipo ').val(sconto_tipo)
    

//-----------inizio calcoli per la tabella riepilogo--------------.---

    var spese_spedizione=parseFloat($('#spese_spedizione ').val());
    var altrioneri_fattura=parseFloat($('#altri_oneri_fattura ').val());

var quotasubtot=0
var totalesconto=0
var totaleconiva=0

//queste variabili servono per rendere stringa tutti i dati inseriti nel form per i prodotti

var val_finale_prodotto=''
var val_finale_descrizione=''
var val_finale_quantita=''
var val_finale_sconto=''
var val_finale_tax=''
var val_finale_tot=''
var val_finale_numero_prodotto=''
var val_finale_sub_tot=''
var val_finale_tipo_sconto=''
var val_finale_prezzo=''
var separatore='@'
  


  //prende il valore per ogni campo di numerazione

  $(".sn").each(function(){
    var valore_campo_numero_riga=$(this).text();
     val_finale_numero_prodotto += valore_campo_numero_riga + separatore
     $('#numero_riga').val( val_finale_numero_prodotto)

    });


  //prende il valore per ogni campo prodotto

  $(".prodotto").each(function(){
     var valore_campo_prodotto=$(this).val();
     val_finale_prodotto += valore_campo_prodotto + separatore
     $('#prodotto').val(val_finale_prodotto)

    });

//prende il valore per ogni campo descrizione

  $(".descrizione").each(function(){
     var valore_campo_descrizione=$(this).val();
     val_finale_descrizione += valore_campo_descrizione + separatore
     $('#descrizione').val(val_finale_descrizione)

    });

  //prende il valore per ogni campo quantita

  $(".quantita").each(function(){
     var valore_campo_quantita=$(this).val();
     val_finale_quantita += valore_campo_quantita + separatore
     $('#quantita').val(val_finale_quantita)

    });

  //prende il valore per ogni campo prezzo

  $(".prezzo").each(function(){
     var valore_campo_prezzo=$(this).val();
     val_finale_prezzo += valore_campo_prezzo + separatore
     $('#prezzo').val(val_finale_prezzo)

    });





//prende il valore per ogni campo sconto
   $(".sconto").each(function(){//per ogni campo sconto_valore
        totalesconto += +$(this).val();
        var valore_campo_sconto=$(this).val();
        val_finale_sconto += valore_campo_sconto+separatore
        $('#sconto').val(val_finale_sconto)
    });


//prende il tipo di sconto per ogni campo
   $(".sconto_tipo").each(function(){//per ogni campo sconto_valore
        var valore_tipo_sconto=$(this).val();
        val_finale_tipo_sconto += valore_tipo_sconto+separatore
        $('#tipo_di_sconto').val(val_finale_tipo_sconto)
    });



//prende il valore per ogni campo subtot
  $(".prezzo_sub_tot").each(function(){
     quotasubtot += +$(this).val();
     var valore_campo_subtot=$(this).val();
     val_finale_sub_tot+= valore_campo_subtot + separatore
     $('#prezzo_sub_tot').val(val_finale_sub_tot)

    });


  //prende il valore per ogni campo iva

  $(".tax").each(function(){
     var valore_campo_iva=$(this).val();
     val_finale_tax += valore_campo_iva + separatore
     $('#tax').val(val_finale_tax)

    });

  //prende il valore per ogni campo totale
    $(".totale").each(function(){//per ogni campo totale
        totaleconiva += +$(this).val();
        var valore_campo_tot=$(this).val();
        val_finale_tot+= valore_campo_tot+separatore
     $('#totale').val(val_finale_tot)
    });


   

    var totaleiva=totaleconiva-quotasubtot

    var totale = totaleconiva + altrioneri_fattura + spese_spedizione
  //visualizzazione nella tabella riepilogativa
    $("#cost_spedizioni").val(spese_spedizione);
    $("#altri_oneri").text(altrioneri_fattura);
    $("#tasse_escluse").val(quotasubtot);
    $("#tot_iva").val(totaleiva);
    $("#sconto_applicato").val(totalesconto)
    $("#totale_della_fattura").val(totale)
});
  
</script>

<script type="text/javascript">   //al cambio di spese di spedizione e altri oneri
  
$('#spese_spedizione').on('change keyup',function(){
var spese_spedizione=$(this).val()
var subtotale=$('#tasse_escluse').val();
var iva=$('#tot_iva').val();
var totaleconiva=+subtotale + +iva
var altrioneri=$('#altri_oneri_fattura').val()
var totale1=totaleconiva+altrioneri+spese_spedizione

$("#altri_oneri").text(altrioneri);
$("#cost_spedizioni").val(spese_spedizione);
$("#totale_della_fattura").val(totale1)
});



$('#altri_oneri_fattura').on('change keyup',function(){
var altrioneri2=$(this).val()
var subtotale2=$('#tasse_escluse').val();
var iva2=$('#tot_iva').val();
var totaleconiva2=+subtotale2 + +iva2
var spese_spedizione2=$('#spese_spedizione').val()
var totale2=totaleconiva2+altrioneri2+spese_spedizione2

$("#altri_oneri").text(altrioneri2);
$("#cost_spedizioni").val(spese_spedizione2);
$("#totale_della_fattura").val(totale2)



if(altrioneri2>0){//abilita/disabilita campo descrizione oneri
  $('#altri_oneri_descrizione').prop('disabled',false);
}
else{
  $('#altri_oneri_descrizione').prop('disabled',true);
}
});
</script>


<script type="text/javascript">

       $(function() {//questo per aggiungere i form set ed eliminarli
               $('#tbl_posts tbody tr').formset({
                   prefix: '{{ formset.prefix }}'
               });
           })
</script>



<!-- ./wrapper -->
{% endif %}

{% endblock %}