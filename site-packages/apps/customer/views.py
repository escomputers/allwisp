from django.http import JsonResponse,HttpResponse, HttpResponseRedirect
from django.shortcuts import get_object_or_404, render, redirect
from django.urls import reverse
from django.contrib.auth.decorators import login_required
import datetime
from django.core.files.storage import FileSystemStorage
import json, os
from django.contrib.auth.decorators import login_required, user_passes_test
from django.forms.models import model_to_dict
from forms import clientiForm,offertainternetForm, cadenzapagamentoform, metodopagamento, offertavoipForm, interessatiForm
from .models import Customer
from apps.items.models import DocumentItem,DocumentItem, offertainternet, cadenzapagamento, metodopagamento
from apps.documents.models import Document
from django.views.generic.edit import UpdateView


#new customer
@login_required
def aggiungi_cliente(request):
	clienti=clientiForm(request.POST)
	try:
		ultimoidclienti=Customer.objects.latest('id')
	except Customer.DoesNotExist:
		ultimoidclienti="nessun id"
	if clienti.is_valid():
		clienti.save()
		return redirect('lista_clienti')
	
	context={"clienti":clienti, 'ultimoid':ultimoidclienti}	
	return render(request, 'customer_new.html',context=context)

	
# Create your views here.
# List all customers
@login_required
def lista_clienti(request):
	customers = Customer.objects.all()
	try:
		ultimoid=Customer.objects.latest('id','customer_id')
		context = {
		'title' : 'Lista clienti',
		'customers' : customers,
		'ultimoid' : ultimoid,
		}
		return render(request, 'customers_list.html', context)		
	except Customer.DoesNotExist:
		return render(request, 'customers_list.html')


# Update customer
@login_required
def update_customer(request, ragionesociale):
		custom = Customer.objects.get(pk=ragionesociale)
		if request.method == "POST":
			clienti=clientiForm(request.POST, instance=custom)
			if clienti.is_valid():
				customer = clienti.save(commit=False)
				customer.save()
				return render( request, 'customer.html', context={'clienti': clienti, 'clientenome':custom})
				#return HttpResponseRedirect(reverse('update', args=(custom.ragionesociale,)))
		else:
			clienti=clientiForm( instance=custom )	
		return render( request, 'customer.html', context={'clienti': clienti, 'clientenome':custom})
            


# Delete customer
@login_required
def elimina_cliente(request, ragionesociale):
	customer = get_object_or_404(Customer, pk=ragionesociale)
	customer.delete()
	return HttpResponseRedirect(reverse('lista_clienti'))


# Delete customer
@login_required
def archivia_cliente(request, ragionesociale):
	customer = get_object_or_404(Customer, pk=ragionesociale)
	customer.stato_cliente_dato="archiviato"
	customer.save()
	return HttpResponseRedirect(reverse('lista_clienti'))
	

